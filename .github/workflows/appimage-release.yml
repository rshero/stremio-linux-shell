name: AppImage Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libnss3 \
            libmpv-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            libasound2t64 \
            libxss1 \
            libxtst6 \
            libxrandr2 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxcursor1 \
            libatk-bridge2.0-0 \
            libdbus-1-3 \
            libcups2 \
            libpango-1.0-0 \
            libcairo2 \
            mesa-utils \
            file \
            wget

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Download Anime4K shaders and ThumbFast
        run: |
          # Download Anime4K shaders
          mkdir -p data/mpv-configs/shaders
          wget -q https://github.com/bloc97/Anime4K/archive/refs/heads/master.zip -O anime4k.zip
          unzip -q anime4k.zip
          mv Anime4K-master/glsl data/mpv-configs/shaders/anime4k
          rm -rf anime4k.zip Anime4K-master

          # Download ThumbFast
          mkdir -p data/mpv-configs/portable_config/{scripts,script-opts}
          wget -q https://raw.githubusercontent.com/po5/thumbfast/master/thumbfast.lua \
            -O data/mpv-configs/portable_config/scripts/thumbfast.lua
          wget -q https://raw.githubusercontent.com/po5/thumbfast/master/thumbfast.conf \
            -O data/mpv-configs/portable_config/script-opts/thumbfast.conf

      - name: Build release binary
        run: cargo build --release

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Prepare AppDir structure
        run: |
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/{16x16,32x32,48x48,128x128,256x256,512x512}/apps
          mkdir -p AppDir/opt/stremio-enhanced

          # Copy binary
          cp target/release/stremio-linux-shell AppDir/opt/stremio-enhanced/

          # Copy server.js
          cp data/server.js AppDir/opt/stremio-enhanced/

          # Copy CEF libraries
          cp -r vendor/cef AppDir/opt/stremio-enhanced/

          # Copy shaders
          mkdir -p AppDir/opt/stremio-enhanced/shaders
          cp -r data/mpv-configs/shaders/anime4k AppDir/opt/stremio-enhanced/shaders/

          # Copy ThumbFast
          mkdir -p AppDir/opt/stremio-enhanced/mpv-configs
          cp -r data/mpv-configs/portable_config AppDir/opt/stremio-enhanced/mpv-configs/

          # Create wrapper script
          cat > AppDir/usr/bin/stremio-enhanced <<'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")/.."
          export LD_LIBRARY_PATH="$APPDIR/opt/stremio-enhanced/cef:$LD_LIBRARY_PATH"
          cd "$APPDIR/opt/stremio-enhanced"
          exec ./stremio-linux-shell "$@"
          EOF
          chmod +x AppDir/usr/bin/stremio-enhanced

          # Create desktop file
          cat > AppDir/usr/share/applications/stremio-enhanced.desktop <<'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Stremio Enhanced
          GenericName=Media Center
          Comment=Enhanced Stremio with MPV, Anime4K, Discord RPC & ThumbFast
          Icon=stremio-enhanced
          Exec=stremio-enhanced %U
          Terminal=false
          Categories=AudioVideo;Video;Player;TV;
          MimeType=x-scheme-handler/stremio;
          Keywords=stream;movie;tv;anime;torrent;
          EOF

          # Copy icons at multiple resolutions
          for size in 16 32 48 128 256 512; do
            cp "data/icons/hicolor/${size}x${size}/apps/stremio-enhanced.png" \
               "AppDir/usr/share/icons/hicolor/${size}x${size}/apps/"
          done

          # Create AppRun
          cat > AppDir/AppRun <<'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$APPDIR/opt/stremio-enhanced/cef:$LD_LIBRARY_PATH"
          cd "$APPDIR/opt/stremio-enhanced"
          exec ./stremio-linux-shell "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          # Create AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/stremio-enhanced.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/stremio-enhanced.png

          # Extract version from tag or use commit SHA
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${GITHUB_SHA::7}
          fi

          # Find and rename the generated AppImage
          GENERATED_APPIMAGE=$(ls Stremio_Enhanced*.AppImage 2>/dev/null | head -n1)
          if [ -z "$GENERATED_APPIMAGE" ]; then
            GENERATED_APPIMAGE=$(ls *.AppImage 2>/dev/null | head -n1)
          fi
          
          if [ -n "$GENERATED_APPIMAGE" ]; then
            mv "$GENERATED_APPIMAGE" "Stremio-Enhanced-${VERSION}-x86_64.AppImage"
          else
            echo "Error: No AppImage file found to rename"
            exit 1
          fi

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            Stremio-Enhanced-*.AppImage
          body: |
            # üé¨ Stremio Enhanced ${{ steps.version.outputs.VERSION }}

            ## ‚ú® Features
            - üé• **MPV Player** with Anime4K AI upscaling (Ctrl+0-6)
            - üéÆ **Discord Rich Presence** - Show what you're watching
            - üì∏ **ThumbFast** - Video thumbnail previews on seekbar
            - üåê **Custom Web UI** - Enhanced interface
            - ‚ö° **Hardware Acceleration** - VAAPI/NVDEC/VDPAU

            ## üì¶ Installation

            ### Quick Start
            ```bash
            # Download the AppImage
            chmod +x Stremio-Enhanced-*.AppImage

            # Run it!
            ./Stremio-Enhanced-*.AppImage
            ```

            ### System Integration (Optional)
            ```bash
            # Extract AppImage
            ./Stremio-Enhanced-*.AppImage --appimage-extract

            # Move to system location
            sudo mv squashfs-root /opt/stremio-enhanced

            # Create symlink
            sudo ln -s /opt/stremio-enhanced/AppRun /usr/local/bin/stremio-enhanced

            # Run from anywhere
            stremio-enhanced
            ```

            ## üéÆ Keyboard Shortcuts
            - **Ctrl+1-6** - Anime4K shader modes (HQ, Denoise, Fast, etc.)
            - **Ctrl+0** - Clear all shaders
            - **Space** - Play/Pause
            - **F/F11** - Fullscreen

            ## ‚öôÔ∏è Configuration
            - **MPV**: `~/.local/share/stremio/mpv-portable/mpv.conf`
            - **Discord**: `~/.local/share/stremio/discord.json` (set `enabled: false` to disable)

            ## üêõ Troubleshooting

            **Discord not showing?**
            ```bash
            echo '{"enabled":true}' > ~/.local/share/stremio/discord.json
            ```

            **Shaders not working?**
            - Play a video first
            - Press Ctrl+1 during playback
            - Check terminal for üé® messages

            **Video won't play?**
            ```bash
            echo "hwdec=no" >> ~/.local/share/stremio/mpv-portable/mpv.conf
            ```

            ## üìù Full Changelog
            See the auto-generated changelog below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stremio-Enhanced-AppImage
          path: Stremio-Enhanced-*.AppImage
