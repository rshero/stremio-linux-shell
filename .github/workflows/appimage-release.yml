name: AppImage Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libnss3 \
            libmpv-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            libasound2t64 \
            libxss1 \
            libxtst6 \
            libxrandr2 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxcursor1 \
            libatk-bridge2.0-0 \
            libdbus-1-3 \
            libcups2 \
            libpango-1.0-0 \
            libcairo2 \
            mesa-utils \
            file \
            wget

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Prepare AppDir structure
        run: |
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/{16x16,32x32,48x48,128x128,256x256,512x512}/apps
          mkdir -p AppDir/opt/stremio-enhanced

          # Copy binary
          cp target/release/stremio-linux-shell AppDir/opt/stremio-enhanced/

          # Copy server.js
          cp data/server.js AppDir/opt/stremio-enhanced/

          # Copy CEF libraries
          cp -r vendor/cef AppDir/opt/stremio-enhanced/

          # Create wrapper script
          cat > AppDir/usr/bin/stremio-enhanced <<'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")/.."
          export LD_LIBRARY_PATH="$APPDIR/opt/stremio-enhanced/cef:$LD_LIBRARY_PATH"
          cd "$APPDIR/opt/stremio-enhanced"
          exec ./stremio-linux-shell "$@"
          EOF
          chmod +x AppDir/usr/bin/stremio-enhanced

          # Create desktop file
          cat > AppDir/usr/share/applications/stremio-enhanced.desktop <<'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Stremio Enhanced
          GenericName=Media Center
          Comment=Enhanced Stremio with MPV & Discord RPC
          Icon=stremio-enhanced
          Exec=stremio-enhanced %U
          Terminal=false
          Categories=AudioVideo;Video;Player;TV;
          MimeType=x-scheme-handler/stremio;
          Keywords=stream;movie;tv;anime;torrent;
          EOF

          # Copy icons at multiple resolutions
          for size in 16 32 48 128 256 512; do
            cp "data/icons/hicolor/${size}x${size}/apps/stremio-enhanced.png" \
               "AppDir/usr/share/icons/hicolor/${size}x${size}/apps/"
          done

          # Create AppRun
          cat > AppDir/AppRun <<'EOF'
          #!/bin/bash
          APPDIR="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$APPDIR/opt/stremio-enhanced/cef:$LD_LIBRARY_PATH"
          cd "$APPDIR/opt/stremio-enhanced"
          exec ./stremio-linux-shell "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          # Create AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/stremio-enhanced.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/stremio-enhanced.png

          # Extract version from tag or use commit SHA
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${GITHUB_SHA::7}
          fi

          # Find and rename the generated AppImage
          GENERATED_APPIMAGE=$(ls Stremio_Enhanced*.AppImage 2>/dev/null | head -n1)
          if [ -z "$GENERATED_APPIMAGE" ]; then
            GENERATED_APPIMAGE=$(ls *.AppImage 2>/dev/null | head -n1)
          fi
          
          if [ -n "$GENERATED_APPIMAGE" ]; then
            mv "$GENERATED_APPIMAGE" "Stremio-Enhanced-${VERSION}-x86_64.AppImage"
          else
            echo "Error: No AppImage file found to rename"
            exit 1
          fi

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            Stremio-Enhanced-*.AppImage
          body: |
            # ðŸŽ¬ Stremio Enhanced ${{ steps.version.outputs.VERSION }}

            ## âœ¨ Features
            - ðŸŽ¥ **MPV Player** - High-quality video playback
            - ðŸŽ® **Discord Rich Presence** - Show what you're watching
            - ðŸŒ **Custom Web UI** - Enhanced interface
            - âš¡ **Hardware Acceleration** - VAAPI/NVDEC/VDPAU

            ## ðŸ“¦ Installation

            ### Quick Start
            ```bash
            # Download the AppImage
            chmod +x Stremio-Enhanced-*.AppImage

            # Run it!
            ./Stremio-Enhanced-*.AppImage
            ```

            ### System Integration (Optional)
            ```bash
            # Extract AppImage
            ./Stremio-Enhanced-*.AppImage --appimage-extract

            # Move to system location
            sudo mv squashfs-root /opt/stremio-enhanced

            # Create symlink
            sudo ln -s /opt/stremio-enhanced/AppRun /usr/local/bin/stremio-enhanced

            # Run from anywhere
            stremio-enhanced
            ```

            ## ðŸŽ® MPV Keyboard Shortcuts
            All standard MPV keyboard shortcuts work during playback:
            - **Space** - Play/Pause
            - **f** - Toggle fullscreen
            - **m** - Mute/unmute
            - **9/0** - Decrease/increase volume
            - **Left/Right** - Seek backward/forward 5 seconds
            - **Up/Down** - Seek forward/backward 1 minute

            You can customize keybindings at: `~/.local/share/stremio/mpv-portable/input.conf`

            ## âš™ï¸ Configuration
            - **MPV**: `~/.local/share/stremio/mpv-portable/mpv.conf`
            - **Discord**: `~/.local/share/stremio/discord.json` (set `enabled: false` to disable)
            - **Shaders**: Place custom shaders in `~/.local/share/stremio/mpv-portable/shaders/`

            ## ðŸ› Troubleshooting

            **Discord not showing?**
            ```bash
            echo '{"enabled":true}' > ~/.local/share/stremio/discord.json
            ```

            **Video won't play?**
            ```bash
            echo "hwdec=no" >> ~/.local/share/stremio/mpv-portable/mpv.conf
            ```

            **Want to add custom shaders (like Anime4K)?**
            1. Download shaders to `~/.local/share/stremio/mpv-portable/shaders/`
            2. Add keybindings in `~/.local/share/stremio/mpv-portable/input.conf`
            3. Example: `CTRL+1 change-list glsl-shaders set "~~/shaders/your-shader.glsl"`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stremio-Enhanced-AppImage
          path: Stremio-Enhanced-*.AppImage
